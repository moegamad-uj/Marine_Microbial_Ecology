---
title: "Bacterial Diversity Across Trade Biomes"
author: "Moegamad Uzair Jack"
date: "`r Sys.Date()`"
output: html_document
---

# Loading Packages
```{r}
library(phyloseq)
library(tidyverse)
library(plyr)
library(vegan)
library(ggplot2)
library(grid)
library(RColorBrewer)
library(viridis)
library(pals)
library(MASS)
```

# Set Working Directory
```{r}
setwd("C:/Users/Uzair/Documents/R/Marine_Microbial_Ecology")
```

# Import OTU and Taxonomy Tables
```{r}
otu_TO <- read.table("TO_OTU.txt", header=TRUE)
tax_TO <- read.delim("TO_TAX.txt", header=TRUE)
tax_TO <- column_to_rownames(tax_TO, "X")
tax_TO <- as.matrix(tax_TO)
otu_TO <- otu_table(otu_TO, taxa_are_rows = TRUE)
tax_TO <- tax_table(tax_TO)
TO <- merge_phyloseq(otu_TO, tax_TO)
```

# Load and Merge Metadata
```{r}
META2 <- read.delim("META2.txt", header=TRUE)
META <- read.delim("ALL_META.txt", header=TRUE)
META_TO <- merge(META2, META, by="PANGAEA")
META_TO <- column_to_rownames(META_TO, "PANGAEA")
MAP <- sample_data(META_TO)
TO1 <- merge_phyloseq(TO, MAP)
```

# Subset Bacteria in Trades Biome and DCM
```{r}
TO.bacteria <- subset_taxa(TO1, Kingdom == "Bacteria")
TO.trades.bac <- subset_samples(TO.bacteria, Marine_pelagic_biomes_Longhurst_2007 == "Trades")
TO.trades.bac.DCM <- subset_samples(TO.trades.bac, EnvironmentalFeature== "(DCM)")
TO.trades.bac.DCM <- subset_samples(TO.trades.bac.DCM, !is.na(Mean_Salinity_PSU))
```

# Normalize to Relative Abundance
```{r}
TO.trades.bac.DCM.rel <- transform_sample_counts(TO.trades.bac.DCM, function(x) x / sum(x))
TO.trades.bac.DCM.rel.mean <- filter_taxa(TO.trades.bac.DCM.rel, function(x) mean(x) > 0, TRUE)
```

# Alpha Diversity Comparison
```{r}
plot_richness(TO.trades.bac.DCM, x = "Ocean_sea_regions", color = "Ocean_sea_regions", measures = c("Shannon", "Chao1")) +
  theme_minimal() +
  labs(title = "Alpha Diversity Across Ocean Basins (Trades, DCM)")
```

# Ordination: PCoA
```{r}
GP.ord <- ordinate(TO.trades.bac.DCM.rel.mean, method = "PCoA", distance = "bray")
plot_ordination(TO.trades.bac.DCM.rel.mean, GP.ord, type = "samples", color = "Mean_Salinity_PSU") +
  labs(title = "PCoA: Bacterial Communities in Trades (DCM)") +
  theme_minimal()
```

# Environmental Fitting (NMDS + envfit)
```{r}
psv <- data.frame(sample_data(TO.trades.bac.DCM.rel.mean))
psotu2veg <- function(physeq) {
  OTU <- otu_table(physeq)
  if (taxa_are_rows(OTU)) {
    OTU <- t(OTU)
  }
  return(as(OTU, "matrix"))
}
ps.otu.veg <- psotu2veg(TO.trades.bac.DCM.rel.mean)
vare.mds <- metaMDS(ps.otu.veg, trace = FALSE)
ef <- envfit(vare.mds, psv, permu = 999, na.rm = TRUE)

par(mfrow = c(1, 2))
plot(vare.mds, display = "sites", main = "NMDS Ordination")
plot(ef, p.max = 0.01, main = "Environmental Vector: Salinity")
par(mfrow = c(1,1))
```

# Barplot of Dominant Bacterial Phyla by Ocean
```{r}
PhylumGlommed <- tax_glom(TO.trades.bac.DCM.rel.mean, "Phylum")
plot_bar(PhylumGlommed, "Sample_label", fill = "Phylum", facet_grid = ~Ocean_sea_regions) + 
  scale_fill_manual(values = colorRampPalette(brewer.pal(8, "Set3"))(length(unique(tax_table(PhylumGlommed)[, "Phylum"])))) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "bottom") +
  labs(title = "Relative Abundance of Bacterial Phyla (Trades, DCM)")
```
