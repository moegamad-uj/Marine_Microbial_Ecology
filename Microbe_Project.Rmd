---
title: "Bacterial Communities in Trades Biomes"
author: "Moegamad Uzair Jack"
date: "`r Sys.Date()`"
output: html_document
---

# Load Packages
```{r}
library(phyloseq)
library(tidyverse)
library(vegan)
library(RColorBrewer)
library(pals)
library(MASS)

```

# Set Working Directory
```{r}
setwd("C:/Users/Uzair/Documents/R/Marine_Microbial_Ecology")
```

# Import OTU and Taxonomy Tables
```{r}
otu_TO <- read.table("TO_OTU.txt", header=TRUE)
tax_TO <- read.delim("TO_TAX.txt", header=TRUE)
tax_TO <- column_to_rownames(tax_TO, "X")
tax_TO <- as.matrix(tax_TO)

otu_TO <- otu_table(otu_TO, taxa_are_rows = TRUE)
tax_TO <- tax_table(tax_TO)
TO <- merge_phyloseq(otu_TO, tax_TO)

```

# Load and Merge Metadata
```{r}
META2 <- read.delim("META2.txt", header=TRUE)
META <- read.delim("ALL_META.txt", header=TRUE)
META_TO <- merge(META2, META, by="PANGAEA")
META_TO <- column_to_rownames(META_TO, "PANGAEA")

MAP <- sample_data(META_TO)
TO1 <- merge_phyloseq(TO, MAP)

```

# Subset: Bacteria Fraction in Trades Biomes
```{r}
TO.bacteria <- subset_taxa(TO1, Kingdom == "Bacteria")
TO.trades.bac <- subset_samples(TO.bacteria, Marine_pelagic_biomes_Longhurst_2007 == "Trades")

```

# Normalise to Relative Abundance
```{r}
TO.trades.bac.rel <- transform_sample_counts(TO.trades.bac, function(x) x / sum(x))
TO.trades.bac.rel.mean <- filter_taxa(TO.trades.bac.rel, function(x) mean(x) > 0, TRUE)

```
# Alpha Diversity  by Ocean Region
```{r}
plot_richness(TO.trades.bac, x = "Ocean_sea_regions", color = "Ocean_sea_regions", measures = c("Shannon", "Chao1")) +
  labs(title = "Alpha Diversity of Bacterial Communities in Trades Biomes") +
  theme_minimal()

```
# Ordination (PCoA)
```{r}
ord_trades <- ordinate(TO.trades.bac.rel.mean, method = "PCoA", distance = "bray")
plot_ordination(TO.trades.bac.rel.mean, ord_trades, type = "samples", color = "Ocean_sea_regions") +
  labs(title = "PCoA: Bacterial Communities in Trades Biomes") +
  theme_minimal()

```



# Environmental Fitting with NMDS
```{r NMDS_and_envfit_plots, message=FALSE, warning=FALSE}
psv <- data.frame(sample_data(TO.trades.bac.rel.mean))

# Convert OTU table to vegan matrix
psotu2veg <- function(physeq) {
  OTU <- otu_table(physeq)
  if (taxa_are_rows(OTU)) { OTU <- t(OTU) }
  return(as(OTU, "matrix"))
}
ps.otu.veg <- psotu2veg(TO.trades.bac.rel.mean)

# NMDS
nmds <- metaMDS(ps.otu.veg, trace = FALSE)
ef <- envfit(nmds, psv, permu = 999, na.rm = TRUE)

# Plot
par(mfrow = c(1,2))
plot(nmds, display = "sites", main = "NMDS Ordination - Trades Biomes")
plot(ef, p.max = 0.01, main = "Environmental Vectors")
par(mfrow = c(1,1))

```
# Barplot of Dominant Bacterial Classes By Ocean
```{r}
ClassGlommed <- tax_glom(TO.trades.bac.rel.mean, "Class")

n_classes <- length(unique(tax_table(ClassGlommed)[, "Class"]))
palette_expanded <- colorRampPalette(brewer.pal(8, "Set3"))(n_classes)

plot_bar(ClassGlommed, "Sample_label", fill = "Class", facet_grid = ~Ocean_sea_regions) +
  scale_fill_manual(values = palette_expanded) +
  labs(title = "Relative Abundance of Bacterial Classes in Trades Biomes") +
  theme(axis.text.x = element_blank())

```
