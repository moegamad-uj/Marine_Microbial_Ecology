---
title: "Bacterial Diversity Across Trade Biomes"
author: "Moegamad Uzair Jack"
date: "`r Sys.Date()`"
output: html_document
---

# Loading Packages
```{r}
library(phyloseq)
library(tidyverse)
library(plyr)
library(vegan)
library(ggplot2)
library(grid)
library(RColorBrewer)
library(viridis)
library(pals)
library(MASS)
```

# Set Working Directory
```{r}
setwd("C:/Users/Uzair/Documents/R/Marine_Microbial_Ecology")
```

# Import OTU and Taxonomy Tables
```{r}
otu_TO <- read.table("TO_OTU.txt", header=TRUE)
tax_TO <- read.delim("TO_TAX.txt", header=TRUE)
rownames(tax_TO) <- tax_TO$X
tax_TO$X <- NULL
tax_TO <- as.matrix(tax_TO)
otu_TO <- otu_table(otu_TO, taxa_are_rows = TRUE)
tax_TO <- tax_table(tax_TO)
TO <- merge_phyloseq(otu_TO, tax_TO)
```

# Load and Merge Metadata
```{r}
META2 <- read.delim("META2.txt", header=TRUE)
META <- read.delim("ALL_META.txt", header=TRUE)
META_TO <- merge(META2, META, by="PANGAEA")
META_TO <- column_to_rownames(META_TO, "PANGAEA")
MAP <- sample_data(META_TO)
TO1 <- merge_phyloseq(TO, MAP)
```

# Subset Bacteria in Trades Biome and DCM
```{r}
TO.bacteria <- subset_taxa(TO1, Kingdom == "Bacteria")
TO.trades.bac <- subset_samples(TO.bacteria, Marine_pelagic_biomes_Longhurst_2007 == "Trades")
TO.trades.bac.DCM <- subset_samples(TO.trades.bac, EnvironmentalFeature== "(DCM)")
TO.trades.bac.DCM <- subset_samples(TO.trades.bac.DCM, !is.na(Mean_Salinity_PSU))
```

# Normalize to Relative Abundance
```{r}
TO.trades.bac.DCM.rel <- transform_sample_counts(TO.trades.bac.DCM, function(x) x / sum(x))
TO.trades.bac.DCM.rel.mean <- filter_taxa(TO.trades.bac.DCM.rel, function(x) mean(x) > 0, TRUE)
```

# Alpha Diversity Comparison
```{r}
# Calculate alpha diversity metrics
plot_richness(TO.trades.bac.DCM, x = "Ocean_sea_regions", 
        color = "Ocean_sea_regions", 
        measures = c("Shannon", "Chao1")) +
  theme_bw() +
  theme(
  axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
  axis.text.y = element_text(size = 10),
  axis.title = element_text(size = 12, face = "bold"),
  plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
  plot.subtitle = element_text(size = 12, hjust = 0.5),
  legend.title = element_text(size = 10, face = "bold"),
  panel.grid.minor = element_blank(),
  strip.background = element_rect(fill = "white"),
  strip.text = element_text(face = "bold")
  ) +
  labs(
  title = "Bacterial Alpha Diversity in Trade Wind Biomes",
  subtitle = "Deep Chlorophyll Maximum (DCM) Layer",
  x = "Ocean Region",
  y = "Alpha Diversity Measure"
  )


```

# Ordination: PCoA
```{r}
# Perform PCoA ordination
GP.ord <- ordinate(TO.trades.bac.DCM.rel.mean, method = "PCoA", distance = "bray")

# Extract percent variance explained for axes 1 and 2
pcoa_var <- GP.ord$values$Relative_eig * 100
x_lab <- paste0("PCoA1 [", round(pcoa_var[1], 1), "%]")
y_lab <- paste0("PCoA2 [", round(pcoa_var[2], 1), "%]")

# Create enhanced plot
plot_ordination(TO.trades.bac.DCM.rel.mean, GP.ord, type = "samples", color = "Mean_Salinity_PSU") +
  geom_point(size = 3, alpha = 0.8) +
  scale_color_viridis(option = "plasma", name = "Salinity (PSU)") +
  theme_bw() +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 10),
    panel.grid.minor = element_blank()
  ) +
  labs(
    title = "Principal Coordinates Analysis of Bacterial Communities",
    subtitle = "Trade Wind Biomes at Deep Chlorophyll Maximum",
      x = x_lab,
      y = y_lab
  )
```


# Environmental Fitting (NMDS + envfit)
```{r}
# Convert phyloseq object to vegan format
psv <- data.frame(sample_data(TO.trades.bac.DCM.rel.mean))
otu_to_vegan <- function(physeq) {
  otu_data <- otu_table(physeq)
  if (taxa_are_rows(otu_data)) {
    otu_data <- t(otu_data)
  }
  return(as(otu_table(physeq), "matrix"))
}
ps_otu_veg <- otu_to_vegan(TO.trades.bac.DCM.rel.mean)

# Perform NMDS ordination
vare_mds <- metaMDS(ps_otu_veg, trace = FALSE, autotransform = FALSE)

# Fit environmental variables
ef <- envfit(vare_mds, psv[c("Mean_Salinity_PSU", "Mean_Temperature_Celsius", "Mean_Oxygen_umol.kg")], 
            permutations = 999)

# Create a single enhanced plot
plot(vare_mds, display = "sites", 
     main = "NMDS Ordination with Environmental Variables",
     sub = "Circles represent sampling sites",
     xlim = c(-2.5, 2.5), ylim = c(-2.5, 2.5),
     type = "n")

# Add points with ocean region colors
points(vare_mds, display = "sites", 
       cex = 2, 
       pch = 21,
       bg = factor(psv$Ocean_sea_regions),
       col = "black")

# Plot environmental vectors with spread-out labels
plot(ef, p.max = 0.01,
     col = "darkred",
     cex = 1.2)

# Add vector labels with offset positions
labels <- c("Salinity", "Temperature", "Oxygen")
arrows <- scores(ef, "vectors") * ordiArrowMul(ef)

text(arrows[,1] * 1.2, arrows[,2] * 1.2,    # Multiply by 1.2 to offset labels
     labels = labels,
     col = "darkred",
     font = 2,
     cex = 0.8)

# Add legend for ocean regions
legend("topright", 
       legend = unique(psv$Ocean_sea_regions),
       pch = 21,
       pt.bg = unique(factor(psv$Ocean_sea_regions)),
       pt.cex = 1.5,
       cex = 0.8,
       title = "Ocean Regions",
       bty = "n")

# Add stress value
stress_label <- paste("Stress =", round(vare_mds$stress, 3))
mtext(stress_label, side = 1, line = 4, adj = 0)
```

# Barplot of Dominant Bacterial Phyla by Ocean
```{r}
# Aggregate at Phylum level and get top 10 phyla
PhylumGlommed <- tax_glom(TO.trades.bac.DCM.rel.mean, "Phylum")
top_phyla <- names(sort(taxa_sums(PhylumGlommed), decreasing = TRUE)[1:15])
PhylumGlommed_filtered <- prune_taxa(top_phyla, PhylumGlommed)

# Create the plot
ggplot(data = psmelt(PhylumGlommed_filtered), 
  aes(x = Sample_label, y = Abundance, fill = Phylum)) +
  geom_bar(stat = "identity", position = "stack", width = 0.8) +
  facet_grid(~Ocean_sea_regions, scales = "free_x", space = "free") +
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(15)) +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    axis.text.y = element_text(size = 10),
    axis.title = element_text(size = 12, face = "bold"),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 9),
    legend.position = "right",
    panel.grid.minor = element_blank(),
    strip.text = element_text(size = 10, face = "bold"),
    strip.background = element_rect(fill = "white")
  ) +
  labs(
    title = "Bacterial Phylum Composition Across Ocean Regions",
    subtitle = "Top 15 Most Abundant Phyla in Trade Wind Biomes at DCM",
    x = "Sample",
    y = "Relative Abundance"
  )
```
