---
title: "Bacterial Communities in Trades Biomes"
author: "Moegamad Uzair Jack"
date: "`r Sys.Date()`"
output: html_document
---

# Load Packages
```{r}
library(phyloseq)
library(tidyverse)
library(vegan)
library(RColorBrewer)
library(pals)
library(MASS)

```

# Set Working Directory
```{r}
setwd("C:/Users/Uzair/Documents/R/Marine_Microbial_Ecology")
```

# Import OTU and Taxonomy Tables
```{r}
otu_TO <- read.table("TO_OTU.txt", header=TRUE)
tax_TO <- read.delim("TO_TAX.txt", header=TRUE)
tax_TO <- column_to_rownames(tax_TO, "X")
tax_TO <- as.matrix(tax_TO)

otu_TO <- otu_table(otu_TO, taxa_are_rows = TRUE)
tax_TO <- tax_table(tax_TO)
TO <- merge_phyloseq(otu_TO, tax_TO)

```

# Load and Merge Metadata
```{r}
META2 <- read.delim("META2.txt", header=TRUE)
META <- read.delim("ALL_META.txt", header=TRUE)
META_TO <- merge(META2, META, by="PANGAEA")
META_TO <- column_to_rownames(META_TO, "PANGAEA")

MAP <- sample_data(META_TO)
TO1 <- merge_phyloseq(TO, MAP)

```

# Subset: Bacteria Fraction in Trades Biomes
```{r}
TO.bacteria <- subset_taxa(TO1, Kingdom == "Bacteria")
TO.trades.bac <- subset_samples(TO.bacteria, Marine_pelagic_biomes_Longhurst_2007 == "Trades")

```

# Normalise to Relative Abundance
```{r}
TO.trades.bac.rel <- transform_sample_counts(TO.trades.bac, function(x) x / sum(x))
TO.trades.bac.rel.mean <- filter_taxa(TO.trades.bac.rel, function(x) mean(x) > 0, TRUE)

```
# Alpha Diversity  by Ocean Region
```{r}
plot_richness(TO.trades.bac, x = "Ocean_sea_regions", color = "Ocean_sea_regions", measures = c("Shannon", "Chao1")) +
  labs(title = "Alpha Diversity of Bacterial Communities in Trades Biomes") +
  theme_minimal()

```
# Ordination (PCoA)
```{r}
ord_trades <- ordinate(TO.trades.bac.rel.mean, method = "PCoA", distance = "bray")
plot_ordination(TO.trades.bac.rel.mean, ord_trades, type = "samples", color = "Ocean_sea_regions") +
  labs(title = "PCoA: Bacterial Communities in Trades Biomes") +
  theme_minimal()

```



# Environmental Fitting with NMDS
```{r NMDS_and_envfit_plots, message=FALSE, warning=FALSE}
# Prepare sample metadata
sample_df <- data.frame(sample_data(TO.trades.bac.rel.mean))

# Convert OTU table to vegan-compatible matrix
otu_to_matrix <- function(physeq) {
  otu <- otu_table(physeq)
  if (taxa_are_rows(otu)) otu <- t(otu)
  return(as(otu, "matrix"))
}

otu_matrix <- otu_to_matrix(TO.trades.bac.rel.mean)

# Run NMDS using Bray-Curtis distance
nmds_result <- metaMDS(otu_matrix, distance = "bray", trace = FALSE)

# Fit environmental variables
envfit_result <- envfit(nmds_result, sample_df, permu = 999, na.rm = TRUE)

# ---- OPTION 1: Display in Viewer (with resizing) ----
par(mfrow = c(1, 1), mar = c(4.5, 4.5, 2.5, 1))  # set margins for both plots

# Plot NMDS ordination
plot(nmds_result, 
     display = "sites", 
     main = "NMDS - Trades Biome (Bacteria)",
     cex = 1.4,              # point size
     cex.main = 1.6,         # title size
     cex.lab = 1.3,          # axis label size
     cex.axis = 1.1)         # tick label size

# Plot environmental vectors
plot(envfit_result, 
     p.max = 0.01, 
     col = "darkblue", 
     main = "Environmental Fit (p < 0.01)")

par(mfrow = c(1, 1))  # reset layout



```

