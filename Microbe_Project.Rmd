---
title: "Bacterial Communities in Trades Biomes"
author: "Moegamad Uzair Jack"
date: "`r Sys.Date()`"
output: html_document
---

# Load Packages
```{r}
library(phyloseq)
library(tidyverse)
library(vegan)
library(RColorBrewer)
library(pals)
library(MASS)

```

# Set Working Directory
```{r}
setwd("C:/Users/Uzair/Documents/R/Marine_Microbial_Ecology")
```

# Import OTU and Taxonomy Tables
```{r}
otu_data <- read.table("TO_OTU.txt", header = TRUE)
tax_data <- read.delim("TO_TAX.txt", header = TRUE)
tax_data <- column_to_rownames(tax_data, "X")
tax_data <- as.matrix(tax_data)

otu_table_obj <- otu_table(otu_data, taxa_are_rows = TRUE)
tax_table_obj <- tax_table(tax_data)
phylo_obj <- merge_phyloseq(otu_table_obj, tax_table_obj)

```

# Load and Merge Metadata
```{r}
meta2_data <- read.delim("META2.txt", header = TRUE)
meta_data <- read.delim("ALL_META.txt", header = TRUE)
meta_combined <- merge(meta2_data, meta_data, by = "PANGAEA")
meta_combined <- column_to_rownames(meta_combined, "PANGAEA")

sample_map <- sample_data(meta_combined)
phylo_complete <- merge_phyloseq(phylo_obj, sample_map)

```

# Subset: Bacteria Fraction in Trades Biomes
```{r}
bacteria_data <- subset_taxa(phylo_complete, Kingdom == "Bacteria")
trades_bacteria <- subset_samples(
  bacteria_data, 
  Marine_pelagic_biomes_Longhurst_2007 == "Trades"
)

```

# Normalise to Relative Abundance
```{r}
bacteria_data <- transform_sample_counts(trades_bacteria, function(x) x / sum(x))
TO.trades.bac.rel.mean <- filter_taxa(bacteria_data, function(x) mean(x) > 0, TRUE)

```
# Alpha Diversity  by Ocean Region
```{r}
# Calculate alpha diversity metrics
alpha_div <- plot_richness(trades_bacteria, x = "Ocean_sea_regions", measures = c("Shannon", "Chao1"))
alpha_data <- alpha_div$data

# Create enhanced plot using ggplot2
ggplot(alpha_data, aes(x = Ocean_sea_regions, y = value, fill = Ocean_sea_regions)) +
  geom_boxplot(alpha = 0.7, outlier.shape = 21) +
  geom_jitter(width = 0.2, alpha = 0.5, size = 2) +
  facet_wrap(~variable, scales = "free_y", nrow = 2) +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Alpha Diversity of Bacterial Communities",
    subtitle = "Trades Biomes across Ocean Regions",
    x = "Ocean Regions",
    y = "Diversity Index Value",
    fill = "Ocean Regions"
  ) +
  theme_minimal() +
  theme(
    text = element_text(size = 12, family = "Arial"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title = element_text(face = "bold"),
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12, face = "italic"),
    panel.grid.minor = element_blank(),
    strip.text = element_text(face = "bold"),
    legend.position = "right"
  )

```
# Ordination (PCoA)
```{r}
# Perform PCoA ordination
ord_trades <- ordinate(TO.trades.bac.rel.mean, method = "PCoA", distance = "bray")

# Create enhanced plot
plot_ordination(TO.trades.bac.rel.mean, ord_trades, type = "samples", color = "Ocean_sea_regions") +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(type = "norm", linetype = 2, aes(color = Ocean_sea_regions)) +
  scale_color_brewer(palette = "Set2") +
  labs(
    title = "Principal Coordinates Analysis (PCoA)",
    subtitle = "Bacterial Communities in Trades Biomes",
    x = paste0("PCoA1 [", round(100 * ord_trades$values$Relative_eig[1], 1), "%]"),
    y = paste0("PCoA2 [", round(100 * ord_trades$values$Relative_eig[2], 1), "%]"),
    color = "Ocean Regions"
  ) +
  theme_minimal() +
  theme(
    text = element_text(size = 12, family = "Arial"),
    axis.text = element_text(size = 10),
    legend.position = "right",
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12, face = "italic"),
    panel.grid.minor = element_blank()
  )

```



# Environmental Fitting with NMDS
```{r NMDS_and_envfit_plots, message=FALSE, warning=FALSE}
# Prepare data for NMDS
otu_matrix <- as(otu_table(TO.trades.bac.rel.mean), "matrix")
if (taxa_are_rows(TO.trades.bac.rel.mean)) {
  otu_matrix <- t(otu_matrix)
}

# Extract metadata and handle missing values
env_data <- data.frame(sample_data(TO.trades.bac.rel.mean))
numeric_env <- env_data[, sapply(env_data, is.numeric)]
numeric_env <- na.omit(numeric_env)  # Remove rows with NA values

# Perform NMDS
set.seed(123)
nmds_result <- metaMDS(otu_matrix, distance = "bray", trymax = 100)
stress <- round(nmds_result$stress, 3)

# Store original plotting parameters
old_par <- par(no.readonly = TRUE)
par(mar = c(5, 5, 4, 12))

# Basic plot
plot(nmds_result, type = "n",
     main = paste("NMDS of Bacterial Communities\n(Stress =", stress, ")"),
     xlab = "NMDS1",
     ylab = "NMDS2",
     cex.main = 1.2,
     cex.lab = 1.1)

# Add points with custom styling
unique_regions <- unique(env_data$Ocean_sea_regions)
n_colors <- length(unique_regions)
# Create color palette for regions
color_palette <- colorRampPalette(brewer.pal(min(8, n_colors), "Dark2"))
region_colors <- setNames(color_palette(n_colors), unique_regions)

# Add points to plot
points(nmds_result,
       pch = 21,
       bg = region_colors[as.character(env_data$Ocean_sea_regions)],
       cex = 2)

# Fit environmental variables
nmds_scores <- scores(nmds_result)
envfit_result <- envfit(nmds_scores, numeric_env, perm = 999)

# Add significant environmental vectors (p < 0.05)
plot(envfit_result, p.max = 0.05, col = "navy", cex = 0.8)

# Add legend for ocean regions
legend("topright",
       legend = unique_regions,
       pch = 21,
       pt.bg = region_colors,
       cex = 0.8,
       title = "Ocean Regions",
       bty = "n",
       inset = c(-0.3, 0))

# Add legend for environmental variables
if (!is.null(envfit_result$vectors)) {
  sig_env <- which(envfit_result$vectors$pvals <= 0.05)
  if (length(sig_env) > 0) {
    legend("right",
           legend = names(numeric_env)[sig_env],
           col = "navy",
           lty = 1,
           cex = 0.8,
           inset = c(-0.3, 0.5))
  }
}

# Reset plotting parameters
par(old_par)


```
# Relative Abundance of Bacterial Classes
```{r}
# Agglomerate taxa at Class level
ClassGlommed <- tax_glom(trades_bacteria, taxrank = "Class")

# Calculate relative abundance
ClassGlommed <- transform_sample_counts(ClassGlommed, function(x) x / sum(x))

# Get number of unique classes for color palette
n_classes <- length(unique(tax_table(ClassGlommed)[, "Class"]))
palette_expanded <- colorRampPalette(brewer.pal(12, "Paired"))(n_classes)

# Create enhanced plot
plot_bar(ClassGlommed, "Sample_label", fill = "Class") +
  facet_grid(~Ocean_sea_regions, scales = "free_x", space = "free") +
  scale_fill_manual(values = palette_expanded) +
  labs(
    title = "Relative Abundance of Bacterial Classes",
    subtitle = "Distribution across Ocean Regions in Trades Biomes",
    x = "Samples",
    y = "Relative Abundance",
    fill = "Bacterial Class"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    panel.grid.minor = element_blank(),
    strip.text = element_text(face = "bold", size = 12),
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12, face = "italic"),
    legend.position = "right",
    legend.text = element_text(size = 8),
    axis.title = element_text(face = "bold")
  )
```

